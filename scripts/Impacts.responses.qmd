---
title: "Impacts.responses"
format: html
editor: visual
---

#### Load packages

```{r}
packages <- c("ggplot2", "readxl", "readr", "ggthemes", "GGally", "caret", "dplyr", "ggformula", "ggpmisc", "gt", "ggpubr", "glmtoolbox", "report", "gtools", "tidyr", "car", "lmtest", "chron", "readxl", "stringr", "imputeTS", "lubridate", "mgcv", "ggplot2", "stringr", "devtools")
invisible(lapply(packages, library, character.only= TRUE))

source_gist("https://gist.github.com/gavinsimpson/e73f011fdaaab4bb5a30")

standard_theme <- theme_bw() + theme(panel.border = element_rect(fill=NA, colour = "black")) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.text.align= 0, legend.title= element_text(size = 12), legend.text = element_text(size= 10), axis.text=element_text(size=10), axis.title=element_text(size=12))

setwd("/Users/sallydowd/Documents/GitHub/NC-Ecosystem-indicators")
RecFishing <- read_csv("data/finalized/e1981RecreationalEffortNCSD.csv")
CommLicense <- read_csv("data/finalized/e1994CommercialLicensesNCCB.csv")
VesselLength <- read_csv("data/finalized/e1989CommercialVesselLengthSD.csv")
ClamsLandings <- read_csv("data/finalized/e1994ClamsLandingsNCSD.csv")
OysterLandings <- read_csv("data/finalized/e1994OysterLandingsNCSD.csv")
CommercialTrips <- read_csv("data/finalized/e1994CommercialTripsNCSD.csv")
MenhadenLandings <- read_csv("data/finalized/e1985MenhadenLandingsNCSD.csv")
CommLandings <- read_csv("data/finalized/e1994CommercialLandingsBillNCSD.csv")

names(RecFishing) <- tolower(names(RecFishing))
RecFishing <- filter(RecFishing, year < 2020)
names(CommLicense) <- tolower(names(CommLicense))
CommLicense <- filter(CommLicense, year < 2020)
names(VesselLength) <- tolower(names(VesselLength))
VesselLength <- filter(VesselLength, year < 2020)
names(ClamsLandings) <- tolower(names(ClamsLandings))
ClamsLandings <- filter(ClamsLandings, year < 2020)
names(OysterLandings) <- tolower(names(OysterLandings))
OysterLandings <- filter(OysterLandings, year < 2020)
names(CommercialTrips) <- tolower(names(CommercialTrips))
CommercialTrips <- filter(CommercialTrips, year < 2020)
names(MenhadenLandings) <- tolower(names(MenhadenLandings))
MenhadenLandings <- filter(MenhadenLandings, year < 2020)
names(CommLandings) <- tolower(names(CommLandings))
CommLandings <- filter(CommLandings, year < 2020)
```

#### GAM Graphs for Impacts and Responses Indicators 

```{r}
#GAM description
#K value: number of basis functions (k), determines how wiggly the model is, should be between 5 and # of years in dataset, start with 2* number of decades in dataset 
#gam.check output: 
  ##Low p-value (k-index<1) may indicate that k is too low, especially if edf is close to k'. Change k from there and see if p-value increases/k-index, compare k and edf values in addition to looking at p value
#s means smooth
  ##If model doesn't converge than the results are likely not correct (too many parameters in model or not enough data)
  ##small (significant) p values indicate residuals are not randomly distributed (not enough basis functions)
#Plots:
  ##: qqplot comparing model residuals to normal distribution, well fit model residuals will be close to straight line
  ##: histogram of residiuals, expect to have symmetric shape
  ##: plot of residual values: should be evenely distributed around 0
  ##: perfect model would form straight line, should cluster around 1:1 line 
```

```{r}
#GAM diagnostics

#Determine k: start with k value from this function
k_det <- function(df){
df1 <- df
((max(df1$year) - max(df1$year) %% 10) - (min(df1$year) - min(df1$year) %% 10))/10 * 2
}

k_det(RecFishing) #6
k_det(CommLicense) #4
k_det(VesselLength) #6
k_det(ClamsLandings) #4
k_det(OysterLandings) #4
k_det(CommercialTrips) #4
k_det(MenhadenLandings) #6
k_det(CommLandings) #4

#Create a GAM - adjust k and remember to check model
gam_diagn <- function(dep_var, k_value, df){
mod <- gam(dep_var ~ s(year, k= k_value), data = df)
print(summary(mod))
gam.check(mod)
}

gam_diagn(RecFishing$angler_trips, 6, RecFishing) #p value not significant 
mod_RecFishing <- gam(angler_trips ~ s(year, k= 6), data = RecFishing)


```

```{r}
pdata <- with(RecFishing, data.frame(year = year))
p2_mod <- predict(mod, newdata = pdata,  type = "terms", se.fit = TRUE)
intercept = as.numeric(attr(p2_mod,"constant")) # look at p2_mod and extract the intercept
pdata <- transform(pdata, p2_mod = p2_mod$fit[,1], se2 = p2_mod$se.fit[,1])

#  Now that we have the model prediction, the next step is to calculate the first derivative
#  Then determine which increases and decreases are significant
Term = "year"
n <- as.numeric(length(unique(pdata$year)))
mod.d <- Deriv(mod, n=n) # n is the number of years
mod.dci <- confint(mod.d, term = Term)
mod.dsig <- signifD(pdata$p2_mod, d = mod.d[[Term]]$deriv, upper = mod.dci[[Term]]$upper, lower = mod.dci[[Term]]$lower)

df <- RecFishing
# Take a quick look to make sure it appears ok before final plotting
plot(angler_trips ~ year, data = df)
lines(angler_trips ~ year, data = df)
lines(p2_mod+intercept ~ year, data = pdata, type = "n")
lines(p2_mod+intercept ~ year, data = pdata)
lines(unlist(mod.dsig$incr)+intercept ~ year, data = pdata, col = "#0072B2", lwd = 3)
lines(unlist(mod.dsig$decr)+intercept ~ year, data = pdata, col = '#D55E00', lwd = 3)
```

```{r}
#check linear model of entire dataset. Then move on to the next chunk based on the results
linearMod<- lm(angler_trips ~ year, data=df)
summary(linearMod)

#check out the post 1997 linear model, then move on to the next chunk based on the results
dfpost1997 <- filter(df, year > 1997)
linearMod<- lm(angler_trips ~ year, data=dfpost1997)
summary(linearMod)

#Plot names
name <- "Number of Recreational Angler Trips"
nospacesname <- gsub(" ", "", name)
```

```{r}
ggplot() + 
  geom_line(data = df, aes(x = year, y = angler_trips), color = 'grey53', alpha = 0.6) +
  geom_point(data = df, aes(x = year, y = angler_trips), color = 'gray53', alpha = 0.6) + 
  geom_line(data=pdata, aes(x = year, y = p2_mod+intercept), se = FALSE, color = 'black', linetype = 'twodash', size = 1) + 
  geom_line(data = pdata, aes(y = unlist(mod.dsig$incr)+intercept, x = year), color = "#0072B2", size = 1) + 
  geom_line(data = pdata, aes(y = unlist(mod.dsig$decr)+intercept, x = year), color = "#D55E00", size = 1) +   geom_smooth(data = dfpost1997, aes(x = year, y = angler_trips), method = lm, se = FALSE, color = "#009E73") +
   geom_smooth(data = df, aes(x = year, y = angler_trips), method = lm, se = FALSE, color = "gray", alpha = 0.2) +
  theme_bw() +
  labs (y = "Angler Trips", x = 'Year', title = paste0(name)) + 
  theme(plot.title=element_text(size = 16,face = 'bold',hjust = 0.5), axis.title=element_text(size = 14, face = 'bold'), axis.text= element_text(color = 'black', size = 12)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
ggsave("/users/sallydowd/desktop/rec.fishing.png")
```
